# Инструкция по деплою SubSwap на Railway

## Подготовка

1. Убедитесь, что у вас есть:
   - Аккаунт на Railway (https://railway.app)
   - Аккаунт на Neon (https://neon.tech)
   - Telegram Bot Token от @BotFather

## Шаги деплоя

### 1. Создание базы данных Neon

1. Зайдите на https://neon.tech и создайте новый проект
2. Скопируйте connection string (DATABASE_URL)
3. Сохраните его для дальнейшего использования

### 2. Создание Telegram-бота

1. Найдите @BotFather в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Сохраните токен бота

### 3. Настройка бота в Telegram

1. Добавьте бота в каналы/чаты, которые будут использоваться
2. Сделайте бота администратором каналов/чатов
3. Настройте WebApp для бота через @BotFather:
   ```
   /newapp
   Выберите бота
   Введите название: SubSwap
   Введите описание: Взаимные подписки
   Загрузите иконку (опционально)
   Введите URL: https://your-app.railway.app
   ```

### 4. Деплой на Railway

1. Зайдите на https://railway.app
2. Создайте новый проект
3. Подключите GitHub репозиторий или загрузите код
4. Railway автоматически определит Node.js проект

### 5. Настройка переменных окружения

В настройках проекта Railway добавьте следующие переменные:

```
BOT_TOKEN=ваш_токен_бота
BOT_USERNAME=имя_вашего_бота
WEBAPP_URL=https://your-app.railway.app
NODE_ENV=production
DATABASE_URL=postgresql://user:password@host/database?sslmode=require
PORT=8080
ADMIN_IDS=ваш_telegram_id,другой_админ_id
```

**Важно:**
- `WEBAPP_URL` должен совпадать с URL вашего Railway приложения
- `ADMIN_IDS` - список Telegram ID администраторов через запятую
- `DATABASE_URL` - connection string из Neon

### 6. Запуск миграций

После первого деплоя выполните миграции базы данных:

1. В Railway откройте консоль (Deployments → View Logs → Open Shell)
2. Выполните команду:
   ```bash
   npm run migrate
   ```

3. Если у вас уже была создана база данных, выполните исправление:
   ```bash
   npm run fix-db
   ```

Или миграции запустятся автоматически при деплое (если настроено в nixpacks.toml)

### 7. Проверка работы

1. Откройте бота в Telegram
2. Отправьте команду `/start`
3. Нажмите кнопку "Открыть MiniApp"
4. Проверьте, что приложение загружается

## Обновление приложения

1. Закоммитьте изменения в репозиторий
2. Railway автоматически задеплоит новую версию
3. Проверьте логи на наличие ошибок

## Мониторинг

- Логи: Railway Dashboard → Deployments → View Logs
- База данных: Neon Dashboard → SQL Editor
- Админ-панель: https://your-app.railway.app/admin

## Troubleshooting

### Бот не отвечает
- Проверьте, что `BOT_TOKEN` правильный
- Убедитесь, что бот запущен (проверьте логи)

### MiniApp не открывается
- Проверьте `WEBAPP_URL` в переменных окружения
- Убедитесь, что URL совпадает с URL приложения
- Проверьте настройки WebApp в @BotFather

### Ошибки базы данных
- Проверьте `DATABASE_URL`
- Убедитесь, что миграции выполнены
- Проверьте подключение к Neon

### Ошибки проверки подписок
- Убедитесь, что бот является администратором каналов
- Проверьте права бота в каналах

