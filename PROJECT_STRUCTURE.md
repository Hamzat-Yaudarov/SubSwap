# Структура проекта SubSwap

## Обзор

Проект состоит из следующих основных компонентов:

### Backend (Node.js + Express)

1. **server.js** - Главный сервер приложения
   - Настройка Express
   - Статические файлы для MiniApp
   - API роуты
   - Запуск планировщика задач

2. **bot.js** - Telegram-бот
   - Обработка команд (/start)
   - Уведомления пользователей
   - Проверка подписок через Telegram API
   - Проверка прав администратора

### База данных (PostgreSQL)

**Схема:**
- `users` - Пользователи (Telegram ID, рейтинг, статус)
- `channels` - Каналы и чаты
- `mutuals` - Взаимки (подписки/реакции)
- `actions` - Действия пользователей
- `mutual_pairs` - Пары взаимок
- `chat_posts` - Посты в мини-чате

**Миграции:**
- `scripts/migrate.js` - Создание всех таблиц и индексов

### API Routes

1. **routes/api.js** - Основные API endpoints
   - Авторизация
   - Профиль
   - Каналы
   - Взаимки
   - Чат

2. **routes/admin.js** - Админ API
   - Управление пользователями
   - Управление каналами
   - Статистика
   - Модерация

### Services

1. **services/mutualService.js** - Логика взаимок
   - Подбор партнёров
   - Проверка выполнения
   - Проверка удержания

2. **services/scheduler.js** - Периодические задачи
   - Проверка удержания подписок
   - Проверка активности каналов
   - Автоматические штрафы

### Frontend (MiniApp)

1. **public/index.html** - Главная страница
   - Навигация (5 экранов)
   - Модальные окна
   - Адаптивный дизайн

2. **public/app.js** - JavaScript логика
   - Работа с Telegram WebApp API
   - API запросы
   - Управление состоянием
   - Навигация

3. **public/styles.css** - Стили
   - Современный дизайн
   - Светлая тема
   - Адаптивность

4. **public/admin.html** - Админ-панель
   - Статистика
   - Управление пользователями
   - Управление каналами

## Поток данных

### Регистрация пользователя
1. Пользователь нажимает /start у бота
2. Бот показывает кнопку "Открыть MiniApp"
3. MiniApp открывается, отправляет initData на /api/auth
4. Создаётся запись в таблице users

### Добавление канала
1. Пользователь вводит ссылку на канал
2. Бот проверяет права (бот и пользователь - админы)
3. Получается информация о канале через Telegram API
4. Канал добавляется в таблицу channels

### Создание взаимки
1. Пользователь выбирает канал и параметры
2. Создаётся запись в таблице mutuals
3. Система ищет подходящих партнёров
4. Создаётся пара в mutual_pairs

### Выполнение взаимки
1. Пользователь нажимает "Участвовать"
2. Создаётся действие в таблице actions
3. Пользователь переходит в Telegram и подписывается
4. Возвращается в MiniApp и нажимает "Проверить"
5. Бот проверяет подписку через getChatMember
6. При успехе - начисляется рейтинг

### Проверка удержания
1. Планировщик каждые 6 часов проверяет все активные пары
2. Для каждой пары проверяется период удержания
3. Если период прошёл, проверяется подписка
4. При отписке - штраф -10 к рейтингу

## Безопасность

1. **Проверка initData** - В production нужно проверять подпись от Telegram
2. **Проверка прав** - Бот проверяет права администратора перед добавлением канала
3. **Рейтинговая система** - Ограничения для пользователей с низким рейтингом
4. **Периодические проверки** - Автоматическая проверка активности каналов

## Масштабирование

- База данных: Neon поддерживает автоматическое масштабирование
- Сервер: Railway автоматически масштабирует при необходимости
- Кэширование: Можно добавить Redis для кэширования частых запросов
- Очереди: Для больших нагрузок можно добавить очередь задач (Bull/BullMQ)

